# Протокол `/ss` (Закриття сесії та Бекап)

Цей протокол виконується для завершення активної сесії, підбиття підсумків, створення бекапу на файловій системі та фіксації змін у Git.

**Виконання:** Передай JSON скрипту `memory_bridge.py` через `run_command` та подякуй користувачу за сесію.

> [!IMPORTANT]
> **Очищення:** Якщо використовувався тимчасовий файл, видали його одразу після завершення `run_command`.
**Семантика:** `/ss` закриває активну сесію. Якщо є текст у лапках, він вважається фінальним фідбеком.

> [!CAUTION]
> ПРОТОКОЛ СКЛАДАЄТЬСЯ З ТРЬОХ ОБОВ'ЯЗКОВИХ КРОКІВ. ТИ МАЄШ ВИКОНАТИ ЇХ УСІ ПО ЧЕРЗІ.

## Крок 1: Запис у FalkorDB (через `memory_bridge.py`)

Ти генеруєш JSON, що містить:
1.  **Сесію:** Вказуєш існуючий `id` сесії та змінюєш `status` на `"closed"`.
2.  **Фідбек (опціонально):** Якщо користувач передав текст, створюєш `:Feedback`.
3.  **Відповідь:** Створюєш фінальний `:Response` з повним текстом своєї відповіді (СЛОВО В СЛОВО).
4.  **Аналіз (Session Summary):** Створюєш `:Analysis` з типом `session_summary`. Підсумовуєш усю сесію: `verdict`, `topics`, `tasks_completed`, `key_decisions`, `errors`, `lessons`. 
    *Зв'язок:* `SUMMARIZES` -> `:Session` та `ANALYZES` -> `:Response`.
5.  **Сутності (`:Entity`):** Аналізуєш всю сесію та витягуєш/оновлюєш УСІ сутності.
6.  **Хронологія:** Оновлюєш `next_links` (до Analysis) та `last_event_id`.

## Крок 2: Збереження повного логу (Бекап) у файл

Ти маєш створити файл у директорії `c:\Antigarvity_workspace\saved_sessions\` (використовуючи інструмент `write_to_file`).

1. **Збір історії:** Збери ВСІ повідомлення поточної сесії (запити, дії, повні відповіді слово в слово).
2. **Визначення теми:** Сформуй коротку тему англійською (snake_case, макс 50 символів), наприклад `graph_schema_refactoring`.
3. **Генерація імені файлу:** Формат `session_YYYY-MM-DD_HH-MM-SS_тема.md`. (Наприклад: `session_2026-02-22_19-50-00_graph_schema_refactoring.md`).
4. **Створення файлу:** Використовуй наступний шаблон:

````markdown
# Сесія: <автоматично визначена тема>

**Дата:** <дата>, <час>
**Тема:** <повна тема>

---

## Запит користувача #1
```
<текст запиту>
```
### Аналіз та дії
<аналіз та дії агента>
### Відповідь #1
<повна відповідь агента, СЛОВО В СЛОВО>

---
*(додати всі наступні запити та відповіді)*
---

## Підсумок сесії

### Обговорені теми:
1. <тема 1>

### Виконані завдання:
1. ✅ <завдання 1>

### Результат:
<коротке резюме>

---
**Кінець сесії**
````

5.  **Оновлення Сесії в Базі:** Після створення файлу, зафіксуй його шлях у графі:
    ```powershell
    docker exec grynya-bridge redis-cli -h falkordb GRAPH.QUERY Grynya "MATCH (s:Session {id: '<session_id>'}) SET s.file_path = '<повний шлях до файлу>'"
    ```

## Крок 3: Git Commit та Push

Після збереження файлу сесії, обов'язково зафіксуй зміни:

```powershell
cd "c:\Antigarvity_workspace"
git commit -am "session: <коротка тема сесії>"
git push
```

## Підтвердження
Поверни користувачу:
```text
✅ Сесія закрита та збережена:
   - FalkorDB: Session [id] → status: closed
   - Файл: saved_sessions/session_<...>.md
   - Git: committed & pushed
```
